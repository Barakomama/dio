<% layout('../layout') -%>

<style type="text/css">
  html { height: 100% }
  body { height: 100%; margin: 0; padding: 0 }
  #map-canvas { 
  	height: 740px;
  	width: 100%;
  }
</style>
<script type="text/javascript"
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAWOlwKkkrv_9ZfMcySRcsNQeKGACHpEA4&sensor=true&libraries=visualization">
</script>
<script type="text/javascript">
// Set to global
var map;
var markers = [];
var heatPoints = [];

  function initialize() {
    
    var latLng = new google.maps.LatLng(14.559, 121.017);

    var mapOptions = {
        center: latLng,
        zoom: 9,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        panControl: true,
        zoomControl: true,          
        streetViewControl: false
    };
    
    map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);


    // Add points using user events

      loadUserEvents();


    //addMapPoint(map);



 }   
 
 google.maps.event.addDomListener(window, 'load', initialize);

 function loadUserEvents () {
   $.ajax({
      url: "/api/user_events",
      dataType: "json",
      data: {dateFrom: $("#dateFrom").val(), dateTo: $("#dateTo").val(), "event": $("#disaster").val()},
      success: function(jsonData){
        if(jsonData.code == 1){
          var userEvents = jsonData.data;
          var map = 
          userEvents.forEach(function(userEvent) {
            addMapPoint(userEvent)
          });

        } else {
          alert(jsonData.message);
        }
      }
   });
 }


  function addMapPoint(userEvent) {

    var latLng = new google.maps.LatLng(userEvent.latitude, userEvent.longitude);

    //TODO: create a template for this
    var content = '<div id="content">'+
      '<div id="siteNotice">'+
      '</div>'+
      '<h4 style="font-size: 16px;margin-bottom: 5px;">'+ userEvent.title +'</h4>'+
      '<p style="font-style: italic;font-weight: 400;font-size: 10px;">'+ userEvent.created +'</p>'+
      '<div id="bodyContent">'+
      '<ul><li><b>Hazard/Disaster Type: </b>' + userEvent.event+
      '<li><b>Description: </b>'+ userEvent.description +
      '</li></div>'+
      '</div>';
      
    var infowindow = new google.maps.InfoWindow({
      content: content
    });
    
    var marker = new google.maps.Marker({
        position: latLng,
        map: map,
        icon: 'public/images/disasters/'+ getIconByIdEvent(userEvent.eventId),
     });
     
    markers.push(marker);

     google.maps.event.addListener(marker, 'click', function() {
        infowindow.open(map,marker);
      });
  }

  function getIconByIdEvent(id) {
    var icon = "";
    switch(id){
      case 1: icon = "flood.png";
        break;
      default: icon = "flood.png";
    }
    return icon;
  }

// Sets the map on all markers in the array.
function setAllMap(map) {
  for (var i = 0; i < markers.length; i++) {
    markers[i].setMap(map);
  }
}

// Removes the markers from the map, but keeps them in the array.
function clearMarkers() {
  setAllMap(null);
}

// Shows any markers currently in the array.
function showMarkers() {
  setAllMap(map);
}

// Deletes all markers in the array by removing references to them.
function deleteMarkers() {
  clearMarkers();
  markers = [];
}

</script>


<div id="map-canvas"/>
